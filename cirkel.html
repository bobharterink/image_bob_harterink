<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/dropzone@6.0.0-beta.2/dist/dropzone.css" />
    <link rel="stylesheet" href="style.css">

</head>

<body>


    <div id="drop_zone" class="disabled dropzone">
        <span class="text-lg">Drag &amp; Drop</span>
        <span class="text-sm">JPEG file here</span>
        <span class="text-sm">— OR —</span>
        <span class="fake-button">Browse Files (This is a 1920*1080 image)</button>
    </div>

    <canvas width="800" height="600" id="mycanvas"></canvas>
    Density dots: <input type="range" min="10" max="100" step="1" oninput="dotDensity(this)">
    dot size: <input type="range" min="1" max="50" step="1" oninput="changedotSize(this)">
    dot color: <input type="color" oninput="changedotColor(this)">


    <label>
        <input type="checkbox" id="modeToggle" checked onchange="changedotColor2()">
        Modify Stroke (Uncheck for Fill)
    </label>
    <br>
    Color: <input type="color" id="colorPicker" oninput="changedotColor2()">




    <label>
        <input type="checkbox" id="uniformScaling" checked>
        Uniform Scaling
    </label>

    <div id="scaleControls">
        <label>Frame size (uniform):
            <input id="scaleUniform" type="range" min="0.1" max="2" step="0.01" value="1"
                oninput="changeframeSize(true)">
        </label>
    </div>

    <div id="nonUniformScaleControls" style="display: none;">
        <label>X Scale:
            <input id="scaleX" type="range" min="0.1" max="2" step="0.01" value="1" oninput="changeframeSize(false)">
        </label>
        <label>Y Scale:
            <input id="scaleY" type="range" min="0.1" max="2" step="0.01" value="1" oninput="changeframeSize(false)">
        </label>
    </div>
    <button id="downloadBtn">Download Image</button>



    <script src="https://unpkg.com/dropzone@6.0.0-beta.2/dist/dropzone-min.js"></script>
    <script src="https://nodebox.live/api/v1/ndbx.js"></script>
    <script>

        document.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
            checkbox.checked = checkbox.defaultChecked;
        })


        const options = {
            userId: 'harterink',
            projectId: 'cirkel',
            canvasId: 'mycanvas',
            autoplay: true
        };

        ndbx.embed(options, function (err, player) {
            window.player = player; // Make the player object global.
        });

        // This function is called when the size slider is dragged.
        function dotDensity(e) {
            window.player.setValue('clamp1', 'v', e.value);
        }
        function changedotSize(e) {
            window.player.setValue('getintensity1', 'divider', e.value);
        }
        function changedotColor(e) {
            window.player.setValue('colorize1', 'stroke', e.value);
        }
        function changedotColor2() {
            const colorPicker = document.getElementById('colorPicker');
            const modeToggle = document.getElementById('modeToggle').checked;
            const color = colorPicker.value;

            if (modeToggle) {
                // Modify stroke, fill is transparent
                window.player.setValue('colorize2', 'stroke', color);
                window.player.setValue('colorize2', 'fill', 'transparent');
            } else {
                // Modify fill, stroke is transparent
                window.player.setValue('colorize2', 'fill', color);
                window.player.setValue('colorize2', 'stroke', 'transparent');
            }
        }



        document.getElementById('uniformScaling').addEventListener('change', function () {
            if (this.checked) {
                document.getElementById('scaleControls').style.display = 'block';
                document.getElementById('nonUniformScaleControls').style.display = 'none';
            } else {
                document.getElementById('scaleControls').style.display = 'none';
                document.getElementById('nonUniformScaleControls').style.display = 'block';
            }
            changeframeSize(this.checked);
        });

        function changeframeSize(isUniform) {

            if (isUniform) {
                const slider = document.getElementById("scaleUniform");
                const scaleValue = parseFloat(slider.value);
                window.player.setValue('scale1', 'scale', { x: scaleValue, y: scaleValue });
            } else {
                const sliderX = document.getElementById("scaleX");
                const sliderY = document.getElementById("scaleY");
                const scaleX = parseFloat(sliderX.value);
                const scaleY = parseFloat(sliderY.value);
                console.log(scaleX, scaleY)
                window.player.setValue('scale1', 'scale', { x: scaleX, y: scaleY });
            }
            // console.log(`Scale (${axis || 'uniform'}): ${scaleValue}`);
        }


        document.getElementById('downloadBtn').addEventListener('click', function () {
            const canvas = document.getElementById('mycanvas');
            const image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");  // This changes the MIME type to download

            // Create a temporary link to initiate the download
            let downloadLink = document.createElement('a');
            downloadLink.href = image;
            downloadLink.download = 'canvas_image.png';

            // Append the link to the document body temporarily and trigger the click event to start download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });


        async function prepareDropzone() {
            const filename = Math.random().toString(36).substring(7) + '.jpeg';
            const url = `https://dangerbuck.s3.eu-north-1.amazonaws.com/uploads/${filename}`;

            let myDropzone = new Dropzone('#drop_zone', {
                url: url,
                method: "put",
                binaryBody: true,
                acceptedFiles: "image/jpeg",
                accept: function (file, done) {
                    // Create an image and load the file data into it
                    const image = new Image();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        image.onload = () => {
                            // Check the dimensions of the image
                            if (image.width > 1920 || image.height > 1280) {
                                // Reject the file if it exceeds the size limits
                                done("The image is too large. Please upload an image no larger than 1920x1280 pixels.");
                            } else {
                                // Accept the file
                                done();
                            }
                        };
                        image.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            myDropzone.on("complete", (file) => {
                if (file.status === Dropzone.SUCCESS) {
                    loadImageWithUrl(url);
                }
            });
        }

        async function loadImageWithUrl(url) {
            const res = await fetch(url, {
                mode: 'cors'
            });
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            const image = new Image();
            image.onload = function () {
                ndbx.assets[url] = image;
                player.setValue('cirkelcode1', 'imageName', url);
                URL.revokeObjectURL(blobUrl);
            }
            image.src = blobUrl;
        }

        prepareDropzone();

    </script>
</body>

</html>